<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tree Hugger SB</title>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script src="http://maps.google.com/maps/api/js"></script>
<script>
// django csrf
if(!document.cookie.match('csrftoken=[a-zA-Z0-9]{32}')) {
    for(var c = ''; c.length < 32;) c += Math.random().toString(36).substr(2, 1)
    document.cookie = 'csrftoken=' + c + '; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/'
}
</script>
    <script>
      function initialize() {
        var mapOptions = {
          center: { lat: 41.6725, lng: -86.2},
          zoom: 13
        };
        var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        // Request current location
        navigator.geolocation.getCurrentPosition(function(pos){
            map.setCenter({lat: pos.coords.latitude, lng: pos.coords.longitude})
            map.setZoom(15)
        })

        // Load tree data and make markers
        d = new XMLHttpRequest()
        d.open('GET', '/api/v1/tree/?limit=1000&format=json', true)
        d.send()
        d.onload = function(){
            trees = JSON.parse(d.responseText).objects
            trees.forEach(function(tree){
                var marker = new google.maps.Marker({position: {lat: tree.latitude, lng: tree.longitude}, map: map})
                marker.data = tree
                addinfowindow(marker)
            })
        }
        // Click to add marker (doesn't work currently)
        google.maps.event.addListener(map, 'click', function(event) {
           placeMarker(event.latLng);
        });
        function placeMarker(loc) {
            var r = new XMLHttpRequest()
            r.open('POST', '/api/v1/tree/', true);
            r.setRequestHeader('X-CSRFToken', document.cookie.match('csrftoken=([a-zA-Z0-9]{32})')[1])
            r.setRequestHeader('Content-Type', 'application/json')
            r.send(JSON.stringify({latitude: loc.lat(), longitude: loc.lng()}))
            r.onload = function(){
                var url = r.getResponseHeader('Location')
                var marker = new google.maps.Marker({position: loc, map: map})
                // TODO: request get the data from the url and assign it to marker.data (before calling addinfowindow())
                marker.id = url.split('/')[url.split('/').length - 1]
                addinfowindow(marker)
            }
        }
      }
      google.maps.event.addDomListener(window, 'load', initialize);

      // Info Window
      function addinfowindow(marker){
        google.maps.event.addListener(marker, 'click', function(e) {
            var infowindow = new google.maps.InfoWindow();
            infowindow.open(marker.map, marker)
            infoDiv = document.createElement('div')
            infowindow.setContent(infoDiv)
            marker.data.images.forEach(function(data){
                var img  = document.createElement('img')
                img.src = data.image
                img.style.maxWidth = '128px'
                img.style.maxHeight = '128px'
                img.style.padding = '10px'
                infoDiv.appendChild(img)
            })
            // Upload Button
            var uploadButton = document.createElement('input')
            uploadButton.type = 'file'
            uploadButton.capture = 'camera'
            uploadButton.accept = 'image/*'
            infoDiv.appendChild(uploadButton)
            uploadButton.onchange = function(){
            var r = new XMLHttpRequest()
                r.open('POST', '/upload/' + marker.data.id + '/', true);
                r.setRequestHeader('X-CSRFToken', document.cookie.match('csrftoken=([a-zA-Z0-9]{32})')[1])
                r.setRequestHeader('Filename', this.files[0].name)
                r.send(this.files[0])
                r.onload = function(){
                    data = JSON.parse(r.responseText)
                    marker.data.images.push(data)
                    var img  = document.createElement('img')
                    img.src = data.image
                    img.style.maxWidth = '128px'
                    img.style.maxHeight = '128px'
                    img.style.padding = '10px'
                    infoDiv.appendChild(img)
                }
                this.value = ''
            }
        })
      }
    </script>
  </head>
  <body>
<div id="map-canvas"></div>
  </body>
</html>
